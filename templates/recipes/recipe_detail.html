{% extends 'base.html' %}
{% load static %}

{% block title %}{{ recipe.name }} - BlissBox{% endblock %}

{% block extra_css %}
<style>
    .ingredient-list {
        background-color: rgb(247, 238, 238);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .ingredient-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #ddd;
    }
    
    .ingredient-item:last-child {
        border-bottom: none;
    }
    
    .ingredient-checkbox {
        margin-right: 15px;
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: rgb(174, 48, 48);
    }
    
    .ingredient-name {
        flex: 1;
        color: gray;
        font-weight: 500;
    }
    
    .ingredient-quantity {
        color: rgb(174, 48, 48);
        font-weight: bold;
        margin-right: 20px;
        min-width: 80px;
    }
    
    .price-breakdown {
        background-color: white;
        border: 2px solid rgb(174, 48, 48);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        position: relative;
        top: 0px;
    }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        color: gray;
    }
    
    .price-row.total {
        border-top: 2px solid rgb(174, 48, 48);
        padding-top: 15px;
        font-weight: bold;
        color: rgb(174, 48, 48);
        font-size: 18px;
    }
    
    .price-row.strike {
        text-decoration: line-through;
        color: #999;
    }

    .recipe-header {
        background: linear-gradient(135deg, #fef5f5 0%, #fde8e8 50%, #fff0f0 100%);
        padding: 40px 20px;
        margin-bottom: 30px;
        box-shadow: 0 4px 20px rgba(174, 48, 48, 0.08);
    }

    .recipe-header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: center;
    }

    .recipe-header-image {
        max-width: 100%;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(174, 48, 48, 0.15);
    }

    .recipe-header-info h1 {
        font-size: 2.5rem;
        color: rgb(174, 48, 48);
        margin-bottom: 15px;
    }

    .recipe-header-info p {
        color: #666;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .recipe-meta-tags {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 15px 0;
    }

    .recipe-tag {
        background-color: rgb(247, 238, 238);
        color: rgb(174, 48, 48);
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    @media (max-width: 768px) {
        .recipe-header-content {
            grid-template-columns: 1fr;
        }
        
        .recipe-header-info h1 {
            font-size: 1.8rem;
        }

        .price-breakdown {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}

<!-- Recipe Header with Image and Intro -->
<div class="recipe-header">
    <div class="recipe-header-content">
        <!-- Recipe Image -->
        <div>
            {% if recipe.featured_image %}
                <img src="{{ recipe.featured_image.url }}" alt="{{ recipe.name }}" class="recipe-header-image">
            {% else %}
                <div style="background: linear-gradient(135deg, rgb(247, 238, 238) 0%, rgb(251, 218, 218) 100%); border-radius: 15px; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">üç∞</div>
                        <div style="color: rgb(174, 48, 48); font-weight: 600;">{{ recipe.name }}</div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Recipe Info -->
        <div class="recipe-header-info">
            <h1>{{ recipe.name }}</h1>
            <p>{{ recipe.description }}</p>
            
            <p><strong style="color: rgb(174, 48, 48);">Time:</strong> 
               <span style="color: gray;">{{ recipe.prep_time_minutes }}m prep + {{ recipe.cook_time_minutes }}m cook</span>
            </p>
            
            <p><strong style="color: rgb(174, 48, 48);">Default Servings:</strong> 
               <span style="color: gray;">{{ recipe.default_servings }}</span>
            </p>
            
            {% if recipe.dietary_tags.all %}
            <p><strong style="color: rgb(174, 48, 48);">üå± Dietary:</strong></p>
            <div class="recipe-meta-tags">
                {% for tag in recipe.dietary_tags.all %}
                <span class="recipe-tag">{{ tag.get_name_display }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Main Content -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; padding: 30px; max-width: 1200px; margin: 0 auto;">
    
    <!-- Ingredients Section -->
    <div>
        <h2 style="color: rgb(174, 48, 48); margin-bottom: 20px;">Whats in the box?</h2>
        <h2 style="color: rgb(174, 48, 48); margin-bottom: 20px;">Ingredients for {{ recipe.default_servings }} Servings</h2>
        
        <!-- Servings Selector -->
        <div style="background-color: white; border: 2px solid rgb(174, 48, 48); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <label style="color: rgb(174, 48, 48); font-weight: bold;">Adjust Servings:</label>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                <button onclick="decreaseServings()" 
                        style="background-color: white; border: 2px solid rgb(174, 48, 48); color: rgb(174, 48, 48); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    ‚àí
                </button>
                <input type="number" 
                       id="servings-input" 
                       value="{{ recipe.default_servings }}" 
                       min="{{ recipe.min_servings }}" 
                       max="{{ recipe.max_servings }}"
                       onchange="updatePrice()"
                       style="width: 60px; text-align: center; border: 1px solid #ddd; padding: 8px; border-radius: 5px;">
                <button onclick="increaseServings()" 
                        style="background-color: white; border: 2px solid rgb(174, 48, 48); color: rgb(174, 48, 48); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    +
                </button>
            </div>
        </div>
        
        <!-- Ingredients List (YOUR EXISTING CLASS!) -->
        <!-- Remove the separate form - put checkboxes directly in the main form -->
<div class="ingredient-list">
    <h3 style="color: rgb(174, 48, 48); margin-bottom: 15px;">Check items you already own:</h3>
    
    <!-- Remove the separate form - put checkboxes directly in the main form -->
    {% for recipe_ingredient in recipe.ingredients.all %}
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="{{ recipe_ingredient.id }}"
               data-quantity="{{ recipe_ingredient.quantity|floatformat:3 }}"
               data-ppu="{{ recipe_ingredient.ingredient.base_price_per_unit|floatformat:3 }}"
               data-unit="{{ recipe_ingredient.ingredient.get_unit_display }}"
               onchange="updatePrice()">
        <span class="ingredient-name">
            {{ recipe_ingredient.ingredient.name }}
            {% if recipe_ingredient.is_optional %}
            <span style="color: #999; font-size: 12px;">(Optional)</span>
            {% endif %}
        </span>
        <span class="ingredient-quantity">
            {{ recipe_ingredient.quantity|floatformat:2 }} {{ recipe_ingredient.ingredient.get_unit_display }}
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ{{ recipe_ingredient.get_price_for_default_servings|floatformat:2 }}
        </span>
    </div>
    {% endfor %}
</div>

        
        <!-- Nutritional Information -->
        <div style="background-color: rgb(247, 238, 238); border-radius: 10px; padding: 20px;">
            <h3 style="color: rgb(174, 48, 48); margin-bottom: 15px;">Nutritional Info (per serving)</h3>
            {% with nutrition=recipe.get_nutritional_info %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <p style="color: gray;"><strong>Calories:</strong> {{ nutrition.calories }} kcal</p>
                    <p style="color: gray;"><strong>Protein:</strong> {{ nutrition.protein_g|floatformat:1 }}g</p>
                </div>
                <div>
                    <p style="color: gray;"><strong>Fat:</strong> {{ nutrition.fat_g|floatformat:1 }}g</p>
                    <p style="color: gray;"><strong>Carbs:</strong> {{ nutrition.carbs_g|floatformat:1 }}g</p>
                </div>
            </div>
            {% endwith %}
        </div>
    </div>
    
    <!-- Price & Cart Section (Sticky Sidebar) -->
    <div>
        <!-- Price Breakdown Card -->
        <div class="price-breakdown">
            <h3 style="color: rgb(174, 48, 48); margin-bottom: 20px;">Price Summary</h3>
            
            <div class="price-row">
                <span>Base Price ({{ recipe.default_servings }} srv):</span>
                <span class="price-row strike">‚Çπ<span id="original-price">{{ recipe.get_total_cost_for_default_servings|floatformat:2 }}</span></span>
            </div>
            
            <div class="price-row" id="excluded-savings" style="display: none;">
                <span style="color: green;">‚úì Items You Have:</span>
                <span style="color: green;">- ‚Çπ<span id="excluded-savings-amount">0</span></span>
            </div>
            
            <div class="price-row" id="servings-adjustment" style="display: none;">
                <span>Servings Adjustment:</span>
                <span id="servings-adjustment-amount">√ó1.0</span>
            </div>
            
            <div class="price-row total">
                <span>Your Price:</span>
                <span>‚Çπ<span id="final-price">{{ recipe.get_total_cost_for_default_servings|floatformat:2 }}</span></span>
            </div>
            
            <p style="color: #999; font-size: 12px; margin-top: 15px; text-align: center;">
                Save money by excluding items you already have!
            </p>
        </div>
        
        <!-- Add to Cart Form -->
        <form method="POST" action="{% url 'cart:add' recipe.id %}" style="margin-top: 20px;">
            {% csrf_token %}

            <!-- Hidden recipe meta for JS (use dashed data-* names) -->
            <input type="hidden"
                   name="recipe"
                   value="{{ recipe.slug }}"
                   data-min-servings="{{ recipe.min_servings }}"
                   data-max-servings="{{ recipe.max_servings }}"
                   data-default-servings="{{ recipe.default_servings }}"
                   data-base-price="{{ recipe.get_total_cost_for_default_servings|floatformat:2 }}">
            
            <!-- Quantity Selector -->
            <div style="margin-bottom: 15px;">
                <label style="color: rgb(174, 48, 48); font-weight: bold;">Quantity:</label>
                <input type="number" 
                       name="quantity" 
                       value="1" 
                       min="1" 
                       max="10"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
            
            <!-- Hidden Inputs for Excluded Ingredients (one per ID) -->
            <div id="excluded-inputs-container"></div>
            
            <!-- Hidden Field for Servings -->
            <input type="hidden" id="servings-field" name="servings" value="{{ recipe.default_servings }}">
            
            <!-- Add to Cart Button -->
            <button type="submit" 
                    style="width: 100%; background-color: rgb(174, 48, 48); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                Add to Cart
            </button>
            
            <button type="button" 
                    onclick="saveLater()"
                    style="width: 100%; background-color: white; color: rgb(174, 48, 48); border: 2px solid rgb(174, 48, 48); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                Save for Later
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Pass Django URL to JavaScript
    window.RECIPES_CALCULATE_PRICE_URL = "{% url 'recipes:calculate-price' %}";
</script>
<script src="{% static 'js/customization.js' %}"></script>
{% endblock %}
        <span class="ingredient-name">
            Cream Cheese
            
        </span>
        <span class="ingredient-quantity">
            200.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ300.00
        </span>
    </div>
    
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="157"
               data-quantity="2.000"
               data-ppu="8.000"
               data-unit=""
               onchange="updatePrice()">
        <span class="ingredient-name">
            Eggs
            
        </span>
        <span class="ingredient-quantity">
            2.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ16.00
        </span>
    </div>
    
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="154"
               data-quantity="250.000"
               data-ppu="0.300"
               data-unit=""
               onchange="updatePrice()">
        <span class="ingredient-name">
            Flour
            
        </span>
        <span class="ingredient-quantity">
            250.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ75.00
        </span>
    </div>
    
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="160"
               data-quantity="100.000"
               data-ppu="0.500"
               data-unit=""
               onchange="updatePrice()">
        <span class="ingredient-name">
            Powdered Sugar
            
        </span>
        <span class="ingredient-quantity">
            100.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ50.00
        </span>
    </div>
    
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="155"
               data-quantity="180.000"
               data-ppu="0.400"
               data-unit=""
               onchange="updatePrice()">
        <span class="ingredient-name">
            Sugar
            
        </span>
        <span class="ingredient-quantity">
            180.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ72.00
        </span>
    </div>
    
    <div class="ingredient-item">
        <input type="checkbox" 
               class="ingredient-checkbox" 
               name="excluded_ingredients" 
               value="158"
               data-quantity="2.000"
               data-ppu="15.000"
               data-unit=""
               onchange="updatePrice()">
        <span class="ingredient-name">
            Vanilla Extract
            
        </span>
        <span class="ingredient-quantity">
            2.00 
        </span>
        <span class="ingredient-price" style="color: green; font-weight: bold;">
            - ‚Çπ30.00
        </span>
    </div>
    
</div>

        
        <!-- Nutritional Information -->
        <div style="background-color: rgb(247, 238, 238); border-radius: 10px; padding: 20px; margin-top: 20px;">
            <h3 style="color: rgb(174, 48, 48); margin-bottom: 15px;">üìä Nutritional Info (per serving)</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <p style="color: gray;"><strong>Calories:</strong> 0 kcal</p>
                    <p style="color: gray;"><strong>Protein:</strong> 0.0g</p>
                </div>
                <div>
                    <p style="color: gray;"><strong>Fat:</strong> 0.0g</p>
                    <p style="color: gray;"><strong>Carbs:</strong> 0.0g</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Price & Cart Section (Sticky Sidebar) -->
    <div>
        <!-- Price Breakdown Card -->
        <div class="price-breakdown">
            <h3 style="color: rgb(174, 48, 48); margin-bottom: 20px;">üí≥ Price Summary</h3>
            
            <div class="price-row">
                <span>Base Price (12 srv):</span>
                <span class="price-row strike">‚Çπ<span id="original-price">663.00</span></span>
            </div>
            
            <div class="price-row" id="excluded-savings" style="display: none;">
                <span style="color: green;">‚úì Items You Have:</span>
                <span style="color: green;">- ‚Çπ<span id="excluded-savings-amount">0</span></span>
            </div>
            
            <div class="price-row" id="servings-adjustment" style="display: none;">
                <span>Servings Adjustment:</span>
                <span id="servings-adjustment-amount">√ó1.0</span>
            </div>
            
            <div class="price-row total">
                <span>Your Price:</span>
                <span>‚Çπ<span id="final-price">663.00</span></span>
            </div>
            
            <p style="color: #999; font-size: 12px; margin-top: 15px; text-align: center;">
                Save money by excluding items you already have!
            </p>
        </div>
        
        <!-- Add to Cart Form -->
        <form method="POST" action="/cart/add/25/" style="margin-top: 20px;">
            <input type="hidden" name="csrfmiddlewaretoken" value="LqpjA8jBpcOsPPpn5jhwbaSsuEF0PD4K2LZ7cQ35fRu1LV22M42BOluuc4JxomPn">

            <!-- Hidden recipe meta for JS (use dashed data-* names) -->
            <input type="hidden"
                   name="recipe"
                   value="red-velvet-cupcakes"
                   data-min-servings="1"
                   data-max-servings="12"
                   data-default-servings="12"
                   data-base-price="663.00">
            
            <!-- Quantity Selector -->
            <div style="margin-bottom: 15px;">
                <label style="color: rgb(174, 48, 48); font-weight: bold;">Quantity:</label>
                <input type="number" 
                       name="quantity" 
                       value="1" 
                       min="1" 
                       max="10"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-top: 5px;">
            </div>
            
            <!-- Hidden Inputs for Excluded Ingredients (one per ID) -->
            <div id="excluded-inputs-container"></div>
            
            <!-- Hidden Field for Servings -->
            <input type="hidden" id="servings-field" name="servings" value="12">
            
            <!-- Add to Cart Button -->
            <button type="submit" 
                    style="width: 100%; background-color: rgb(174, 48, 48); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                üõí Add to Cart
            </button>
            
            <button type="button" 
                    onclick="saveLater()"
                    style="width: 100%; background-color: white; color: rgb(174, 48, 48); border: 2px solid rgb(174, 48, 48); padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 14px; font-weight: bold; cursor: pointer; transition: 0.3s;">
                ‚ù§Ô∏è Save for Later
            </button>
        </form>
    </div>
</div>


    
    <!-- Footer (Reusing your email-box class) -->
    <footer class="footer">
        <div class="contact-details">
            <h3 style="color: rgb(174, 48, 48); font-weight: bold;">Get Recipe Updates!</h3>
            <p>Subscribe to our newsletter for new recipes and exclusive offers.</p>
            
            <!-- Email Subscription (Your existing email-box styling) -->
            <div class="email-box">
                <form method="POST" action="/subscribe/">
                    <input type="hidden" name="csrfmiddlewaretoken" value="LqpjA8jBpcOsPPpn5jhwbaSsuEF0PD4K2LZ7cQ35fRu1LV22M42BOluuc4JxomPn">
                    <input type="email" 
                           id="email-input" 
                           name="email" 
                           placeholder="Enter your email" 
                           required>
                    <button type="submit" style="background-color: rgb(174, 48, 48); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                        Subscribe
                    </button>
                </form>
            </div>
            
            <!-- Social Icons -->
            <div class="social-icons">
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
            </div>
        </div>
        
        <p style="margin-top: 30px; color: gray;">
            ¬© 2025 BlissBox. All rights reserved. | 
            <a href="#" style="color: rgb(174, 48, 48); text-decoration: none;">Privacy Policy</a> | 
            <a href="#" style="color: rgb(174, 48, 48); text-decoration: none;">Terms of Service</a>
        </p>
    </footer>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="/static/js/menu.js"></script>
    
    
<script>
    // Pass Django URL to JavaScript
    window.RECIPES_CALCULATE_PRICE_URL = "/calculate-price/";
</script>
<script src="/static/js/customization.js"></script>

</body>
</html>