{% extends 'base.html' %}
{% block title %}Products{% endblock %}

{% block extra_css %}
<style>
  .products-container {
    max-width: 100%;
    padding: 0 20px;
  }
  
  .product-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
  
  @media (max-width: 1200px) {
    .product-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 768px) {
    .product-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid products-container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 style="margin:0;top: 50px;position: relative;right: -11px;">Products</h3>
    <div class="products-count">{{ products_count }} products found</div>
  </div>

  <div class="row">
    <aside class="col-md-2">
      <div class="sidebar">
        <div class="filters-header">
          <h5 style="margin:0;">Filters</h5>
          <a href="{% url 'recipes:products' %}" class="btn btn-link">Clear all</a>
        </div>
        <form method="get">
          <div class="mb-3">
            <label class="form-label">Categories</label>
            {% for cat in categories %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="category" value="{{ cat.slug }}" {% if cat.slug in selected.categories %}checked{% endif %}>
                <label class="form-check-label">{{ cat.name }}</label>
              </div>
            {% endfor %}
          </div>

          <div class="mb-3">
            <label class="form-label">Price range</label>
            <div class="d-flex" style="gap:8px;">
              <input type="number" step="0.01" class="form-control" name="min_price" placeholder="Min" value="{{ selected.min_price }}">
              <input type="number" step="0.01" class="form-control" name="max_price" placeholder="Max" value="{{ selected.max_price }}">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Brand</label>
            <select name="brand" class="form-select">
              <option value="">Any</option>
              {% for b in brands %}
                <option value="{{ b }}" {% if selected.brand == b %}selected{% endif %}>{{ b }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="inStock" name="available" value="1" {% if selected.available == '1' %}checked{% endif %}>
            <label class="form-check-label" for="inStock">In stock only</label>
          </div>

          <div class="mb-3">
            <label class="form-label">Customer rating</label>
            <select name="rating" class="form-select">
              <option value="">Any</option>
              <option value="4" >4+ stars</option>
              <option value="3" >3+ stars</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary w-100">Apply filters</button>
        </form>
      </div>
    </aside>

    <section class="col-md-10">
      <div class="d-flex justify-content-end mb-2">
        <form method="get" class="d-flex" style="gap:8px;">
          {% for key, value in request.GET.items %}
            {% if key != 'sort' %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endif %}
          {% endfor %}
          <select name="sort" class="form-select" onchange="this.form.submit()">
            <option value="newest" {% if selected.sort == 'newest' %}selected{% endif %}>Newest Arrivals</option>
            <option value="price_asc" {% if selected.sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
            <option value="price_desc" {% if selected.sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
            <option value="best_selling" {% if selected.sort == 'best_selling' %}selected{% endif %}>Best Selling</option>
            <option value="rating" {% if selected.sort == 'rating' %}selected{% endif %}>Customer Ratings</option>
            <option value="az" {% if selected.sort == 'az' %}selected{% endif %}>Alphabetical: A-Z</option>
            <option value="za" {% if selected.sort == 'za' %}selected{% endif %}>Alphabetical: Z-A</option>
          </select>
        </form>
      </div>

      <div class="product-grid">
        {% for p in products %}
        <div class="product-card" data-id="{{ p.id }}" data-name="{{ p.name }}" data-price="{{ p.base_price }}" data-image="{% if p.featured_image %}{{ p.featured_image.url }}{% endif %}">
          <div class="product-img-wrap">
            {% if p.featured_image %}
              <img class="product-img" src="{{ p.featured_image.url }}" alt="{{ p.name }}" loading="lazy">
            {% else %}
              <div class="d-flex align-items-center justify-content-center" style="height:180px; background:#fafafa;">üç∞</div>
            {% endif %}
          </div>
          <div class="product-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="product-title"><a href="{% url 'recipes:product' slug=p.slug %}">{{ p.name }}</a></div>
              <button class="btn btn-light btn-sm wishlist-btn" title="Wishlist">‚ù§</button>
            </div>
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <div class="product-price">‚Çπ{{ p.base_price }}</div>
            <div class="card-actions">
              <form method="post" action="{% url 'cart:add' p.id %}">
                {% csrf_token %}
                <input type="hidden" name="quantity" value="1">
                <button class="btn btn-primary btn-sm" type="submit">Add to Cart</button>
              </form>
              {# Compare removed #}
            </div>
          </div>
        </div>
        {% empty %}
          <p>No products match your filters.</p>
        {% endfor %}
      </div>

      <div class="d-flex justify-content-center mt-3 pagination">
        {% if is_paginated %}
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&{{ querystring }}">Previous</a>
          {% endif %}
          <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&{{ querystring }}">Next</a>
          {% endif %}
        {% endif %}
      </div>
    </section>
  </div>
</div>

<div class="modal" tabindex="-1" id="quickViewModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qvTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <img id="qvImg" src="" alt="" style="width:100%; border-radius:6px; margin-bottom:10px; display:none;"/>
        <div id="qvPrice" class="product-price"></div>
      </div>
    </div>
  </div>
</div>

{# Compare bar removed #}

<script>
  (function(){
    var wishlist = JSON.parse(localStorage.getItem('wishlist')||'[]');

    // Wishlist toggle
    document.querySelectorAll('.wishlist-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var card = btn.closest('.product-card');
        var id = card.dataset.id;
        var idx = wishlist.indexOf(id);
        if(idx === -1){ wishlist.push(id); } else { wishlist.splice(idx,1); }
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        btn.classList.toggle('btn-danger');
      });
    });

    // Quick view modal
    var qvModal = document.getElementById('quickViewModal');
    var qv = new bootstrap.Modal(qvModal);
    document.querySelectorAll('.quick-view').forEach(function(btn){
      btn.addEventListener('click', function(){
        var card = btn.closest('.product-card');
        document.getElementById('qvTitle').textContent = card.dataset.name;
        document.getElementById('qvPrice').textContent = '‚Çπ' + card.dataset.price;
        var img = document.getElementById('qvImg');
        if(card.dataset.image){ img.src = card.dataset.image; img.style.display='block'; } else { img.style.display='none'; }
        qv.show();
      });
    });

    // Clean up any legacy 'compare' data if it exists (safe no-op if absent)
    localStorage.removeItem('compare');
  })();
</script>
{% endblock %}
